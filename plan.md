# Plan for the API service

This project is supposed to allow projects to check their code for REUSE
compliance. Although inclusion in CI/CD is [fairly
simple](https://reuse.software/dev/), an API-like system would allow for
a more simple connection with other services.

## Features

The features are listed by priority:

* Show the status of the latest linting process under `/<user>/<repo>/`
  Offer a
* badge under `/<user>/<repo>/badge.svg` indicating the REUSE compliance
  status
* Offer a JSON endpoint which shows the REUSE status under
* `/<user>/<repo>/status.json` Show the full output of the latest
  linting
* process under `/<user>/<repo>/`

Note: Since we do not only want to handle GitHub, the URLS above also
have to contain the source forge name/URL. Perhaps we can make some
short forms (e.g.  `gh/<user>/...` for GitHub), but otherwise use the
host name like `/git.fsfe.org/<user>/...`. Here, it might become tricky
when services don't use the user/repo format. If it's too complicated,
we could postpone this feature to a later release.

## User experience

A user could follow these steps to interact with our service:

1. Enter/register their project with our service on the start page
2. Be forwarded to the REUSE status page of their project on
   `/<user>/<repo>/`
3. Be pointed to the badge and the JSON endpoint

We could think about a required email confirmation in step 1 to a) save
resources on our end and b) have a communication channel with all users
to inform about changes. This could be realised by using our
[forms](https://git.fsfe.org/fsfe-system-hackers/forms/) service. All
confirmed entries will be saved in a JSON file which the REUSE API
service can parse.


## Under the hood

### Run the checks

In order to start a REUSE check, this service could send an SSH command
to our server and monitor its output and exit code.

```
$ ssh -i ~/.ssh/reuse_ed25519 reuse@52.59.164.134 reuse-lint-repo https://git.fsfe.org/reuse/tool
Cloning into '/project'...

Running REUSE check:

SUMMARY

Bad licenses: 0
Missing licenses: 0
Unused licenses: 0
Used licenses: Apache-2.0, CC-BY-SA-4.0, CC0-1.0, GPL-3.0-or-later
Read errors: 0
Files with copyright information: 51 / 51
Files with license information: 51 / 51

Congratulations! Your project is compliant with version 3.0 of the REUSE Specification :-)
```

The server is capable to handle multiple large jobs at the same time,
and it would be easily scalable.


### Database/caching

A tricky part would be the sensible caching of results. If we would have
hundreds of projects registered with this service, it cause an enormeous
performance hit if we checked them every time the badge, JSON file or
page is requested. At the same time, we want to ship up-to-date results.

Here are a few ideas how this could be realised using a simple database
(sqlite?):

* Save the latest commit hash of the master branch, e.g. using `git
  ls-remote https://git.fsfe.org/reuse/tool master`. If it didn't
  change, the REUSE status did neither.
* With that, save the latest output of the REUSE check in the database
  as well.
* In the background, check regularly for updated master branches and
  execute a REUSE check if it has been changed recently.
* Save the last access time of either the badge, JSON endpoint, or
  status page. This way, we can track if a project's REUSE status is
  actually requested. If it's inactive for a longer time, we can ignore
  it until the next access.

The database structure could look like this:

| project                           | commit                                    | lint_status   | lint_code | lint_output                           | last_access |
| --------------------------------- | ----------------------------------------- | ------------- | --------- | ------------------------------------- | ----------- |
| https://git.fsfe.org/reuse/tool   | d76521506d424c1c813b3987cf8501f130b3845f  | compliant     | 0         | Running REUSE check:\n\nSUMMARY\n...  | 1564227088  |
| https://git.fsfe.org/pmpc/website | 6b4e0a76a505795fe5b76c071b0acf15bbbd23cb  | non-compliant | 1         | Running REUSE check:\n\nSUMMARY\n...  | 1564227100  |

(lint_status and lint_code might be a bit too overlapping)


### Badges

Depending on the status, different badges can be displayed under
`badges.svg` of each project. These can be generated by shields.io under
a CC0 license. Examples:

[![REUSE status](https://img.shields.io/badge/REUSE-compliant-green)](https://reuse.software)
[![REUSE status](https://img.shields.io/badge/REUSE-non--compliant-red)](https://reuse.software)
[![REUSE status](https://img.shields.io/static/v1?label=REUSE&message=checking...&color=yellow)](https://reuse.software)


### JSON

A JSON endpoint makes parsing our checks simple for external
applications. It could look like this:

```json
{
  "reuse-version": 3.0,
  "project": "https://git.fsfe.org/reuse/tool",
  "lint_status": "compliant",
  "lint_code": "0",
  "lint_output": "Running REUSE check:\n\nSUMMARY\n...",
  "badge": "https://check.reuse.software/git.fsfe.org/reuse/tool/badge.svg"
}
```
